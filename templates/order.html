{% extends "base.html" %}

{% block title %}Order Tires - TireTrack Pro{% endblock %}

{% block content %}
<div class="container" style="max-width: 1200px; margin: 2rem auto; padding: 0 2rem;">
    <div class="page-header" style="margin-bottom: 2rem;">
        <h1 style="font-size: 2.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.5rem;">
            <i class="fas fa-shopping-cart" style="color: var(--primary-color);"></i>
            Customer Orders
        </h1>
        <p style="font-size: 1.125rem; color: var(--text-secondary);">
            Select a service or find the perfect tires for your vehicle
        </p>
    </div>

    <!-- Shopping Cart Summary -->
    <div id="cart-summary" style="display: none; position: fixed; top: 80px; right: 20px; background: white; border-radius: 12px; padding: 1.5rem; box-shadow: var(--shadow-xl); max-width: 350px; z-index: 1000; border: 2px solid var(--primary-color);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin: 0;">
                <i class="fas fa-shopping-cart"></i> Your Order
            </h3>
            <button id="close-cart" style="background: none; border: none; cursor: pointer; font-size: 1.5rem; color: var(--text-secondary);" aria-label="Close cart">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="cart-items" style="margin-bottom: 1rem; max-height: 300px; overflow-y: auto;"></div>
        <div style="border-top: 2px solid var(--border-color); padding-top: 1rem;">
            <div style="display: flex; justify-content: space-between; font-size: 1.25rem; font-weight: 700; color: var(--text-primary); margin-bottom: 1rem;">
                <span>Total:</span>
                <span id="cart-total">$0.00</span>
            </div>
            <button id="checkout-btn" style="width: 100%; background: var(--gradient-primary); color: white; padding: 0.875rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                <i class="fas fa-check"></i> Checkout
            </button>
        </div>
    </div>

    <!-- Service Items Section -->
    <div style="margin-bottom: 3rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="font-size: 1.75rem; font-weight: 600; color: var(--text-primary); margin: 0;">
                <i class="fas fa-tools" style="color: var(--primary-color);"></i>
                Available Services
            </h2>
            <button id="view-cart-btn" style="display: none; background: var(--gradient-primary); color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                <i class="fas fa-shopping-cart"></i> View Order (<span id="cart-count">0</span>)
            </button>
        </div>
        <div id="services-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
            <!-- Service cards will be generated by JavaScript -->
        </div>
    </div>

    <!-- Tire Search Section -->
    <div id="tire-search-section" style="scroll-margin-top: 2rem;">
        <h2 style="font-size: 1.75rem; font-weight: 600; color: var(--text-primary); margin-bottom: 1.5rem;">
            <i class="fas fa-search" style="color: var(--primary-color);"></i>
            Search for Tires
        </h2>
    </div>

    <!-- Search Options Cards -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 3rem;">
        <!-- Direct Size Search Card -->
        <div class="card" style="background: white; border-radius: 12px; padding: 2rem; box-shadow: var(--shadow-md);">
            <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary);">
                <i class="fas fa-search" style="color: var(--primary-color);"></i>
                Search by Tire Size
            </h2>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                Enter tire size directly (e.g., 205/55R16, 235-45-18)
            </p>
            <form id="size-search-form">
                <div style="margin-bottom: 1rem;">
                    <label for="tire-size-input" style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">
                        Tire Size
                    </label>
                    <input 
                        type="text" 
                        id="tire-size-input" 
                        name="tire_size"
                        placeholder="e.g., 235/45R18 or 235-45-18"
                        style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem;"
                        required
                    />
                    <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
                        Accepted formats: 235/45R18, 235-45-18, 235/45/18
                    </small>
                </div>
                <button 
                    type="submit"
                    style="width: 100%; background: var(--gradient-primary); color: white; padding: 0.875rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: transform 0.2s;"
                    onmouseover="this.style.transform='translateY(-2px)'"
                    onmouseout="this.style.transform='translateY(0)'"
                >
                    <i class="fas fa-search"></i> Search Tires
                </button>
            </form>
        </div>

        <!-- Vehicle Search Card -->
        <div class="card" style="background: white; border-radius: 12px; padding: 2rem; box-shadow: var(--shadow-md);">
            <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary);">
                <i class="fas fa-car" style="color: var(--primary-color);"></i>
                Search by Vehicle
            </h2>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                Select your car's make, model, and year
            </p>
            <form id="vehicle-search-form">
                <div style="margin-bottom: 1rem;">
                    <label for="make-select" style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">
                        Make
                    </label>
                    <select 
                        id="make-select"
                        style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem; background: white;"
                        required
                    >
                        <option value="">Select Make</option>
                        {% for make in makes %}
                        <option value="{{ make }}">{{ make }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label for="model-select" style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">
                        Model
                    </label>
                    <select 
                        id="model-select"
                        style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem; background: white;"
                        disabled
                        required
                    >
                        <option value="">Select Model</option>
                    </select>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label for="year-select" style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">
                        Year
                    </label>
                    <select 
                        id="year-select"
                        style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem; background: white;"
                        disabled
                        required
                    >
                        <option value="">Select Year</option>
                    </select>
                </div>
                <button 
                    type="submit"
                    style="width: 100%; background: var(--gradient-primary); color: white; padding: 0.875rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: transform 0.2s;"
                    onmouseover="this.style.transform='translateY(-2px)'"
                    onmouseout="this.style.transform='translateY(0)'"
                >
                    <i class="fas fa-search"></i> Find Tires
                </button>
            </form>
        </div>
    </div>

    <!-- Selected Tire Size Display -->
    <div id="selected-size-display" style="display: none; background: var(--gradient-success); color: white; padding: 1rem 1.5rem; border-radius: 8px; margin-bottom: 2rem; box-shadow: var(--shadow-md);">
        <p style="font-size: 1.125rem; font-weight: 600;">
            <i class="fas fa-check-circle"></i>
            Showing tires for size: <span id="selected-size-text"></span>
        </p>
    </div>

    <!-- Results Section -->
    <div id="results-section" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="font-size: 1.75rem; font-weight: 600; color: var(--text-primary);">
                Available Tires
            </h2>
            <div id="results-count" style="color: var(--text-secondary); font-size: 1rem;"></div>
        </div>
        
        <!-- Loading Spinner -->
        <div id="loading" style="text-align: center; padding: 3rem; display: none;">
            <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: var(--primary-color);"></i>
            <p style="margin-top: 1rem; color: var(--text-secondary);">Loading tires...</p>
        </div>

        <!-- No Results Message -->
        <div id="no-results" style="display: none; text-align: center; padding: 3rem; background: white; border-radius: 12px; box-shadow: var(--shadow-md);">
            <i class="fas fa-info-circle" style="font-size: 3rem; color: var(--warning-color); margin-bottom: 1rem;"></i>
            <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem; color: var(--text-primary);">No Tires Found</h3>
            <p style="color: var(--text-secondary);">We don't have any tires matching your search criteria at this time.</p>
        </div>

        <!-- Results Grid -->
        <div id="tires-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem;">
            <!-- Tire cards will be inserted here by JavaScript -->
        </div>
    </div>
</div>

<style>
.tire-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: var(--shadow-md);
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.tire-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-xl);
    border-color: var(--primary-color);
}

.tire-card.out-of-stock {
    opacity: 0.6;
    background: #f8f9fa;
    cursor: not-allowed;
}

.tire-card.out-of-stock:hover {
    transform: none;
    border-color: transparent;
}

.tire-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 1rem;
}

.tire-brand {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary);
}

.tire-model {
    font-size: 1rem;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
}

.stock-badge {
    padding: 0.375rem 0.75rem;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 600;
    white-space: nowrap;
}

.stock-badge.in-stock {
    background: var(--success-color);
    color: white;
}

.stock-badge.out-of-stock {
    background: var(--danger-color);
    color: white;
}

.tire-details {
    margin: 1rem 0;
    padding: 1rem;
    background: var(--light-bg);
    border-radius: 8px;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

.detail-label {
    color: var(--text-secondary);
    font-weight: 500;
}

.detail-value {
    color: var(--text-primary);
    font-weight: 600;
}

.tire-price {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--primary-color);
    margin: 1rem 0;
}

.tire-description {
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin: 0.75rem 0;
    line-height: 1.5;
}

.order-button {
    width: 100%;
    padding: 0.875rem;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 1rem;
}

.order-button.available {
    background: var(--gradient-primary);
    color: white;
}

.order-button.available:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.order-button.unavailable {
    background: #e2e8f0;
    color: #94a3b8;
    cursor: not-allowed;
}

.order-button.special-order {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    cursor: pointer;
}

.order-button.special-order:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.special-order-badge {
    display: inline-block;
    background: var(--warning-color);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-left: 0.5rem;
}

/* Service Card Styles */
.service-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: var(--shadow-md);
    transition: all 0.3s ease;
    border: 2px solid transparent;
    cursor: pointer;
}

.service-card:hover,
.service-card:focus {
    transform: translateY(-4px);
    box-shadow: var(--shadow-xl);
    border-color: var(--primary-color);
    outline: none;
}

.service-card.new-tires {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.service-card.new-tires:hover,
.service-card.new-tires:focus {
    border-color: transparent;
}

.service-card.in-cart {
    border-color: var(--success-color);
    background: #f0fdf4;
}

/* Cart Item Styles */
.cart-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: var(--light-bg);
    border-radius: 8px;
    margin-bottom: 0.5rem;
}

.cart-item-remove {
    background: var(--danger-color);
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    cursor: pointer;
    font-size: 0.875rem;
    transition: all 0.2s;
}

.cart-item-remove:hover,
.cart-item-remove:focus {
    background: #dc2626;
    transform: scale(1.1);
    outline: none;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Service definitions
    const services = [
        {
            id: 'tire-rotation',
            name: 'Tire Rotation',
            price: 49.99,
            icon: 'sync-alt',
            description: 'Regular tire rotation extends tire life and ensures even wear patterns for optimal performance.',
            type: 'regular'
        },
        {
            id: 'new-tires',
            name: 'New Tires',
            price: 0,
            icon: 'tire',
            description: 'Browse our extensive tire inventory. Click to search by size or vehicle make/model.',
            type: 'special',
            action: 'scroll'
        },
        {
            id: 'alignment',
            name: 'Alignment',
            price: 89.99,
            icon: 'sliders-h',
            description: 'Precise wheel alignment improves handling, extends tire life, and enhances fuel efficiency.',
            type: 'regular'
        },
        {
            id: 'inspection',
            name: 'Inspection',
            price: 29.99,
            icon: 'clipboard-check',
            description: 'Comprehensive vehicle inspection to ensure safety and identify potential issues early.',
            type: 'regular'
        },
        {
            id: 'emissions',
            name: 'Emissions',
            price: 39.99,
            icon: 'smog',
            description: 'State-required emissions testing to ensure your vehicle meets environmental standards.',
            type: 'regular'
        }
    ];

    // Shopping cart
    const cart = [];
    
    // Elements
    const sizeSearchForm = document.getElementById('size-search-form');
    const vehicleSearchForm = document.getElementById('vehicle-search-form');
    const makeSelect = document.getElementById('make-select');
    const modelSelect = document.getElementById('model-select');
    const yearSelect = document.getElementById('year-select');
    const resultsSection = document.getElementById('results-section');
    const tiresGrid = document.getElementById('tires-grid');
    const loading = document.getElementById('loading');
    const noResults = document.getElementById('no-results');
    const selectedSizeDisplay = document.getElementById('selected-size-display');
    const selectedSizeText = document.getElementById('selected-size-text');
    const resultsCount = document.getElementById('results-count');
    const servicesGrid = document.getElementById('services-grid');
    const cartSummary = document.getElementById('cart-summary');
    const viewCartBtn = document.getElementById('view-cart-btn');
    const closeCartBtn = document.getElementById('close-cart');
    const checkoutBtn = document.getElementById('checkout-btn');
    const cartItems = document.getElementById('cart-items');
    const cartTotal = document.getElementById('cart-total');
    const cartCount = document.getElementById('cart-count');

    // Generate service cards
    function generateServiceCards() {
        servicesGrid.innerHTML = '';
        services.forEach(service => {
            const card = document.createElement('div');
            card.className = 'service-card' + (service.type === 'special' ? ' new-tires' : '');
            card.setAttribute('role', 'button');
            card.setAttribute('tabindex', '0');
            card.setAttribute('data-service-id', service.id);
            card.setAttribute('aria-label', `${service.name} - ${service.price > 0 ? '$' + service.price.toFixed(2) : 'Search Below'}`);
            
            const isSpecial = service.type === 'special';
            const textColor = isSpecial ? 'white' : 'var(--text-primary)';
            const priceColor = isSpecial ? 'rgba(255, 255, 255, 0.9)' : 'var(--primary-color)';
            const descColor = isSpecial ? 'rgba(255, 255, 255, 0.95)' : 'var(--text-secondary)';
            const iconBg = isSpecial ? 'rgba(255, 255, 255, 0.2)' : 'var(--gradient-primary)';
            
            card.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                    <div style="width: 50px; height: 50px; background: ${iconBg}; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 1rem;">
                        <i class="fas fa-${service.icon}" style="color: white; font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <h3 style="font-size: 1.25rem; font-weight: 600; color: ${textColor}; margin: 0;">${service.name}</h3>
                        <data value="${service.price}" style="font-size: ${isSpecial ? '1rem' : '1.5rem'}; font-weight: ${isSpecial ? '600' : '700'}; color: ${priceColor}; margin: 0; display: block;">
                            ${service.price > 0 ? '$' + service.price.toFixed(2) : 'Search Below'}
                        </data>
                    </div>
                </div>
                <p style="color: ${descColor}; font-size: 0.9rem; line-height: 1.5;">
                    ${service.description}
                </p>
                ${isSpecial ? `
                <div style="margin-top: 1rem; padding: 0.5rem; background: rgba(255, 255, 255, 0.15); border-radius: 6px; text-align: center;">
                    <span style="color: white; font-weight: 600; font-size: 0.85rem;">
                        <i class="fas fa-arrow-down"></i> Click to Browse Tires
                    </span>
                </div>
                ` : ''}
            `;
            
            // Add click handler
            const handleClick = () => {
                if (service.action === 'scroll') {
                    document.getElementById('tire-search-section').scrollIntoView({ behavior: 'smooth' });
                } else {
                    addToCart(service);
                }
            };
            
            card.addEventListener('click', handleClick);
            card.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    handleClick();
                }
            });
            
            servicesGrid.appendChild(card);
        });
    }

    // Add item to cart
    function addToCart(service) {
        const existing = cart.find(item => item.id === service.id);
        if (existing) {
            existing.quantity++;
        } else {
            cart.push({
                id: service.id,
                name: service.name,
                price: service.price,
                quantity: 1
            });
        }
        updateCart();
        showCartNotification(service.name);
    }

    // Remove item from cart
    function removeFromCart(serviceId) {
        const index = cart.findIndex(item => item.id === serviceId);
        if (index !== -1) {
            cart.splice(index, 1);
            updateCart();
        }
    }

    // Update cart display
    function updateCart() {
        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const count = cart.reduce((sum, item) => sum + item.quantity, 0);
        
        cartTotal.textContent = '$' + total.toFixed(2);
        cartCount.textContent = count;
        
        if (count > 0) {
            viewCartBtn.style.display = 'inline-block';
        } else {
            viewCartBtn.style.display = 'none';
            cartSummary.style.display = 'none';
        }
        
        cartItems.innerHTML = '';
        cart.forEach(item => {
            const itemEl = document.createElement('div');
            itemEl.className = 'cart-item';

            // Left section (name, qty, price)
            const leftDiv = document.createElement('div');

            const nameDiv = document.createElement('div');
            nameDiv.style.fontWeight = '600';
            nameDiv.textContent = item.name;
            leftDiv.appendChild(nameDiv);

            const qtyDiv = document.createElement('div');
            qtyDiv.style.fontSize = '0.875rem';
            qtyDiv.style.color = 'var(--text-secondary)';
            qtyDiv.textContent = `Qty: ${item.quantity} Ã— $${item.price.toFixed(2)}`;
            leftDiv.appendChild(qtyDiv);

            // Right section (total, remove button)
            const rightDiv = document.createElement('div');
            rightDiv.style.display = 'flex';
            rightDiv.style.alignItems = 'center';
            rightDiv.style.gap = '0.5rem';

            const totalSpan = document.createElement('span');
            totalSpan.style.fontWeight = '700';
            totalSpan.style.color = 'var(--primary-color)';
            totalSpan.textContent = `$${(item.price * item.quantity).toFixed(2)}`;
            rightDiv.appendChild(totalSpan);

            const removeBtn = document.createElement('button');
            removeBtn.className = 'cart-item-remove';
            removeBtn.setAttribute('data-service-id', item.id);
            removeBtn.setAttribute('aria-label', `Remove ${item.name}`);
            removeBtn.innerHTML = '<i class="fas fa-times"></i>';
            rightDiv.appendChild(removeBtn);

            itemEl.appendChild(leftDiv);
            itemEl.appendChild(rightDiv);
            cartItems.appendChild(itemEl);
        });
        
        // Update service cards to show in-cart state
        document.querySelectorAll('.service-card').forEach(card => {
            const serviceId = card.getAttribute('data-service-id');
            const inCart = cart.some(item => item.id === serviceId);
            if (inCart) {
                card.classList.add('in-cart');
            } else {
                card.classList.remove('in-cart');
            }
        });
    }

    // Show cart notification
    function showCartNotification(serviceName) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow-xl);
            z-index: 2000;
            animation: slideIn 0.3s ease;
        `;
        notification.innerHTML = `
            <i class="fas fa-check-circle"></i> ${serviceName} added to order!
        `;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transition = 'opacity 0.3s';
            setTimeout(() => notification.remove(), 300);
        }, 2000);
    }

    // Event listeners
    viewCartBtn.addEventListener('click', () => {
        cartSummary.style.display = 'block';
    });

    closeCartBtn.addEventListener('click', () => {
        cartSummary.style.display = 'none';
    });

    checkoutBtn.addEventListener('click', () => {
        const itemsList = cart.map(item => 
            `${item.name} (Qty: ${item.quantity}) - $${(item.price * item.quantity).toFixed(2)}`
        ).join('\n');
        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        
        alert(`Order Summary:\n\n${itemsList}\n\nTotal: $${total.toFixed(2)}\n\nThis is a demo. In production, this would process your order.`);
    });

    // Remove item from cart
    cartItems.addEventListener('click', (e) => {
        const removeBtn = e.target.closest('.cart-item-remove');
        if (removeBtn) {
            const serviceId = removeBtn.getAttribute('data-service-id');
            removeFromCart(serviceId);
        }
    });

    // Initialize service cards
    generateServiceCards();

    // Normalize tire size format (e.g., 235-45-18 or 235/45/18 to 235/45R18)
    function normalizeTireSize(size) {
        // Remove spaces
        size = size.trim().toUpperCase();
        
        // Convert dashes or slashes to standard format
        size = size.replace(/-/g, '/');
        
        // If no R, add it before the last number
        if (!size.includes('R')) {
            const parts = size.split('/');
            if (parts.length === 3) {
                size = parts[0] + '/' + parts[1] + 'R' + parts[2];
            }
        }
        
        return size;
    }

    // Handle direct size search
    sizeSearchForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const sizeInput = document.getElementById('tire-size-input').value;
        const normalizedSize = normalizeTireSize(sizeInput);
        searchTiresBySize(normalizedSize);
    });

    // Handle make selection
    makeSelect.addEventListener('change', async function() {
        const make = this.value;
        modelSelect.disabled = true;
        yearSelect.disabled = true;
        modelSelect.innerHTML = '<option value="">Loading...</option>';
        yearSelect.innerHTML = '<option value="">Select Year</option>';
        
        if (make) {
            try {
                const response = await fetch(`/api/vehicle-models/${encodeURIComponent(make)}`);
                const models = await response.json();
                
                modelSelect.innerHTML = '<option value="">Select Model</option>';
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    modelSelect.appendChild(option);
                });
                modelSelect.disabled = false;
            } catch (error) {
                console.error('Error loading models:', error);
                modelSelect.innerHTML = '<option value="">Error loading models</option>';
            }
        } else {
            modelSelect.innerHTML = '<option value="">Select Model</option>';
            yearSelect.innerHTML = '<option value="">Select Year</option>';
        }
    });

    // Handle model selection
    modelSelect.addEventListener('change', async function() {
        const make = makeSelect.value;
        const model = this.value;
        yearSelect.disabled = true;
        yearSelect.innerHTML = '<option value="">Loading...</option>';
        
        if (make && model) {
            try {
                const response = await fetch(`/api/vehicle-years/${encodeURIComponent(make)}/${encodeURIComponent(model)}`);
                const years = await response.json();
                
                yearSelect.innerHTML = '<option value="">Select Year</option>';
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                });
                yearSelect.disabled = false;
            } catch (error) {
                console.error('Error loading years:', error);
                yearSelect.innerHTML = '<option value="">Error loading years</option>';
            }
        } else {
            yearSelect.innerHTML = '<option value="">Select Year</option>';
        }
    });

    // Handle vehicle search form submission
    vehicleSearchForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const make = makeSelect.value;
        const model = modelSelect.value;
        const year = yearSelect.value;
        
        if (make && model && year) {
            try {
                const response = await fetch(`/api/tire-size/${encodeURIComponent(make)}/${encodeURIComponent(model)}/${year}`);
                const data = await response.json();
                
                if (data.tire_size) {
                    searchTiresBySize(data.tire_size);
                } else {
                    alert('Tire size not found for this vehicle.');
                }
            } catch (error) {
                console.error('Error getting tire size:', error);
                alert('Error finding tire size for this vehicle.');
            }
        }
    });

    // Search tires by size
    async function searchTiresBySize(size) {
        // Show results section and loading
        resultsSection.style.display = 'block';
        loading.style.display = 'block';
        tiresGrid.style.display = 'none';
        noResults.style.display = 'none';
        selectedSizeDisplay.style.display = 'block';
        selectedSizeText.textContent = size;

        // Scroll to results
        resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

        try {
            const response = await fetch(`/api/tires-by-size/${encodeURIComponent(size)}`);
            const tires = await response.json();
            
            loading.style.display = 'none';
            
            if (tires.length === 0) {
                noResults.style.display = 'block';
            } else {
                displayTires(tires);
            }
        } catch (error) {
            console.error('Error searching tires:', error);
            loading.style.display = 'none';
            noResults.style.display = 'block';
        }
    }

    // Display tires in grid
    function displayTires(tires) {
        tiresGrid.innerHTML = '';
        tiresGrid.style.display = 'grid';
        
        resultsCount.textContent = `${tires.length} tire${tires.length !== 1 ? 's' : ''} found`;
        
        tires.forEach(tire => {
            const card = createTireCard(tire);
            tiresGrid.appendChild(card);
        });
    }

    // Create tire card element
    function createTireCard(tire) {
        const card = document.createElement('div');
        card.className = `tire-card ${tire.in_stock ? '' : 'out-of-stock'}`;
        
        // Escape HTML to prevent XSS
        const escapeHtml = (text) => {
            if (text == null) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        };
        
        const escapeJs = (text) => {
            if (!text) return '';
            return text.replace(/\\/g, '\\\\')
                      .replace(/'/g, "\\'")
                      .replace(/"/g, '\\"')
                      .replace(/`/g, '\\`')
                      .replace(/\$/g, '\\$')
                      .replace(/\n/g, '\\n')
                      .replace(/\r/g, '\\r')
                      .replace(/\t/g, '\\t')
                      .replace(/</g, '\\u003C')
                      .replace(/>/g, '\\u003E');
        };
        
        const escapedBrand = escapeHtml(tire.brand);
        const escapedModel = escapeHtml(tire.model);
        const escapedSize = escapeHtml(tire.size);
        const escapedType = escapeHtml(tire.type);
        const escapedSpeedRating = escapeHtml(tire.speed_rating);
        const escapedLoadIndex = escapeHtml(tire.load_index);
        const escapedDescription = escapeHtml(tire.description);
        
        const jsBrand = escapeJs(tire.brand);
        const jsModel = escapeJs(tire.model);
        
        // Determine button properties
        let buttonClass, buttonIcon, buttonText, buttonDisabled, buttonOnClick;
        
        if (tire.in_stock) {
            buttonClass = 'available';
            buttonIcon = 'shopping-cart';
            buttonText = 'Add to Order';
            buttonDisabled = '';
            buttonOnClick = `alert('Order placed for ${jsBrand} ${jsModel}!\\n\\nThis is a demo. In production, this would process the order.')`;
        } else if (tire.special_order_available) {
            buttonClass = 'special-order';
            buttonIcon = 'clock';
            buttonText = 'Special Order';
            buttonDisabled = '';
            buttonOnClick = `alert('Special order request submitted for ${jsBrand} ${jsModel}!\\n\\nThis is a demo. In production, this would process the special order with estimated delivery time.')`;
        } else {
            buttonClass = 'unavailable';
            buttonIcon = 'ban';
            buttonText = 'Out of Stock';
            buttonDisabled = 'disabled';
            buttonOnClick = '';
        }
        
        card.innerHTML = `
            <div class="tire-header">
                <div>
                    <div class="tire-brand">${escapedBrand}</div>
                    <div class="tire-model">${escapedModel}</div>
                </div>
                <span class="stock-badge ${tire.in_stock ? 'in-stock' : 'out-of-stock'}">
                    ${tire.in_stock ? `${tire.quantity_in_stock} In Stock` : 'Out of Stock'}
                </span>
            </div>
            
            <div class="tire-details">
                <div class="detail-row">
                    <span class="detail-label">Size:</span>
                    <span class="detail-value">${escapedSize}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Type:</span>
                    <span class="detail-value">${escapedType}</span>
                </div>
                ${tire.speed_rating ? `
                <div class="detail-row">
                    <span class="detail-label">Speed Rating:</span>
                    <span class="detail-value">${escapedSpeedRating}</span>
                </div>
                ` : ''}
                ${tire.load_index ? `
                <div class="detail-row">
                    <span class="detail-label">Load Index:</span>
                    <span class="detail-value">${escapedLoadIndex}</span>
                </div>
                ` : ''}
                ${tire.warranty_months ? `
                <div class="detail-row">
                    <span class="detail-label">Warranty:</span>
                    <span class="detail-value">${tire.warranty_months} months</span>
                </div>
                ` : ''}
            </div>
            
            ${tire.description ? `
            <div class="tire-description">
                ${escapedDescription}
            </div>
            ` : ''}
            
            <div class="tire-price">
                $${tire.retail_price.toFixed(2)}
                ${!tire.in_stock && tire.special_order_available ? '<span class="special-order-badge"><i class="fas fa-clock"></i> Special Order Available</span>' : ''}
            </div>
            
            <button 
                class="order-button ${buttonClass}"
                ${buttonDisabled}
                onclick="${buttonOnClick}"
            >
                <i class="fas fa-${buttonIcon}"></i>
                ${buttonText}
            </button>
        `;
        
        return card;
    }
});
</script>
{% endblock %}
